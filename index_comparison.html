<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Comparison</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script>
        // Fix Canvas2D warnings
        (function() {
            const originalProtoGetContext = HTMLCanvasElement.prototype.getContext;
            HTMLCanvasElement.prototype.getContext = function(contextType, contextAttributes) {
                if (contextType === '2d' || contextType === '2D') {
                    contextAttributes = contextAttributes || {};
                    contextAttributes.willReadFrequently = true;
                }
                return originalProtoGetContext.call(this, contextType, contextAttributes);
            };
        })();
    </script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f9fafb;
        }
        h1 {
            color: #1f2937;
            margin-bottom: 8px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #3b82f6;
            text-decoration: none;
        }
        .controls {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .model-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .model-card h3 {
            margin: 0 0 15px 0;
            color: #1f2937;
        }
        .plot-container {
            width: 100%;
            height: 450px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin-right: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        .info {
            background: #dbeafe;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to overview</a>
    <h1>‚öñÔ∏è Embedding Model Comparison</h1>
    <p style="color: #6b7280; margin-bottom: 20px;">
        Compare how different embedding models cluster the same text chunks
    </p>

    <div class="controls">
        <h3 style="margin-top: 0;">Select Models to Compare</h3>
        <label><input type="checkbox" value="openai-small" checked> OpenAI Small (1536d)</label><br>
        <label><input type="checkbox" value="openai-large" checked> OpenAI Large (3072d)</label><br>
        <label><input type="checkbox" value="voyage-2"> Voyage-2 (1024d)</label><br>
        <label><input type="checkbox" value="cohere-v3"> Cohere v3 (1024d)</label><br><br>

        <label>Reduction Technique:
            <select id="technique">
                <option value="pca">PCA</option>
                <option value="isomap">Isomap</option>
            </select>
        </label><br><br>

        <button onclick="runComparison()">Generate Comparison</button>
        <button onclick="loadDemo()">Load Demo Data</button>

        <div class="info">
            <strong>üí° Tips:</strong>
            <ul style="margin: 10px 0;">
                <li>Chunks with same color across models = same text</li>
                <li>Look for differences in clustering patterns</li>
                <li>Models that cluster similarly may have similar semantic understanding</li>
            </ul>
        </div>
    </div>

    <div id="modelGrid" class="model-grid"></div>

    <script src="dist/shared.js?v=3"></script>
    <script src="src/embedding-manager.js"></script>
    <script>
        const manager = new EmbeddingManager();
        let chunks = [];
        let chunkColors = [];

        // Generate consistent colors for chunks
        function generateChunkColors(n) {
            const colors = [];
            for (let i = 0; i < n; i++) {
                const hue = (i * 137.508) % 360; // Golden angle
                colors.push(`hsl(${hue}, 70%, 60%)`);
            }
            return colors;
        }

        async function runComparison() {
            if (chunks.length === 0) {
                alert('Please load demo data first or implement data input');
                return;
            }

            const selectedModels = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);

            if (selectedModels.length === 0) {
                alert('Please select at least one model');
                return;
            }

            const technique = document.getElementById('technique').value;
            const grid = document.getElementById('modelGrid');
            grid.innerHTML = '';

            for (const model of selectedModels) {
                const card = document.createElement('div');
                card.className = 'model-card';
                card.innerHTML = `
                    <h3>${model}</h3>
                    <div class="plot-container" id="plot-${model}"></div>
                    <div style="margin-top: 10px; font-size: 13px; color: #6b7280;">
                        Loading...
                    </div>
                `;
                grid.appendChild(card);

                // Generate embeddings (in demo, we'll use synthetic)
                const embeddings = chunks.map((chunk, idx) => {
                    // Synthetic: add model-specific variation
                    const seed = model.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
                    return Array(128).fill(0).map((_, i) =>
                        Math.sin(idx + i + seed) + Math.random() * 0.3
                    );
                });

                // Apply dimensionality reduction
                let reduced;
                if (technique === 'pca') {
                    reduced = pca(embeddings, 3);
                } else {
                    reduced = isomap(embeddings, 3, 12);
                }

                // Plot
                const trace = {
                    x: reduced.map(p => p[0]),
                    y: reduced.map(p => p[1]),
                    z: reduced.map(p => p[2]),
                    mode: 'markers',
                    type: 'scatter3d',
                    text: chunks.map((c, i) => `Chunk ${i}: ${c.substring(0, 50)}...`),
                    marker: {
                        size: 6,
                        color: chunkColors,
                        opacity: 0.8,
                        line: { color: 'white', width: 0.5 }
                    },
                    hovertemplate: '%{text}<extra></extra>'
                };

                const layout = {
                    margin: { l: 0, r: 0, t: 0, b: 0 },
                    scene: {
                        xaxis: { title: '' },
                        yaxis: { title: '' },
                        zaxis: { title: '' },
                        camera: { eye: { x: 1.5, y: 1.5, z: 1.5 } }
                    }
                };

                Plotly.newPlot(`plot-${model}`, [trace], layout, {
                    responsive: true,
                    displayModeBar: false
                });

                card.querySelector('div[style]').textContent =
                    `${chunks.length} chunks ‚Ä¢ ${technique.toUpperCase()}`;
            }
        }

        function loadDemo() {
            chunks = [
                "Machine learning algorithms learn patterns from data",
                "Neural networks consist of interconnected layers of nodes",
                "Deep learning uses multiple layers for feature extraction",
                "Natural language processing analyzes human language",
                "Computer vision enables machines to interpret images",
                "The cat sat on the mat and purred contentedly",
                "Dogs are loyal companions and love to play fetch",
                "Birds fly south for the winter migration",
                "Fish swim in schools for protection",
                "Elephants have excellent memory and social bonds",
                "Python is a popular programming language",
                "JavaScript runs in web browsers",
                "SQL databases store structured data",
                "API endpoints provide data access",
                "Cloud computing enables scalable infrastructure",
                "Quantum mechanics describes atomic behavior",
                "Einstein's relativity changed physics",
                "Photosynthesis converts sunlight to energy",
                "DNA contains genetic information",
                "Evolution explains species diversity"
            ];
            chunkColors = generateChunkColors(chunks.length);
            alert(`Loaded ${chunks.length} demo chunks. Click "Generate Comparison" to visualize.`);
        }

        // Load demo on page load
        window.addEventListener('load', loadDemo);
    </script>
</body>
</html>
